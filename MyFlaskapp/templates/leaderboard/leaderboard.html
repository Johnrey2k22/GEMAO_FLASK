{% extends "base.html" %}

{% block title %}Leaderboard{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4">Leaderboard <small id="updateStatus" class="text-muted">Live</small></h2>
        
        {% if session.get('user_role') != 'admin' %}
        <!-- View Toggle Buttons -->
        <div class="btn-group mb-3" role="group">
            <button type="button" class="btn btn-primary" id="personalViewBtn" onclick="switchView('personal')">
                My Scores
            </button>
            <button type="button" class="btn btn-outline-primary" id="globalViewBtn" onclick="switchView('global')">
                Global Leaderboard
            </button>
        </div>
        {% else %}
        {% endif %}
        
        {% if session.get('user_role') != 'admin' %}
        <!-- Personal Scores Section -->
        <div id="personalScoresSection" class="mb-4">
            <h4 class="mb-3">Your Personal Scores</h4>
            <div class="table-responsive">
                <table id="personalTable" class="table table-striped">
                    <thead>
                        <tr>
                            <th data-sort="number">Rank</th>
                            <th data-sort="string">Game</th>
                            <th data-sort="number">Score</th>
                            <th data-sort="date">Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for score in user_scores %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td>{{ score.game_name }}</td>
                            <td>{{ score.score }}</td>
                            <td>{{ score.date_played }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% if user_scores|length == 0 %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> You haven't played any games yet. <a href="{{ url_for('games.games_list') }}">Start playing!</a>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- Global Scores Section -->
        <div id="globalScoresSection" class="mb-4"{% if session.get('user_role') == 'admin' %} style="display: block;"{% else %} style="display: none;"{% endif %}>
            <h4 class="mb-3">Global Leaderboard</h4>
            <div class="table-responsive">
                <table id="globalTable" class="table table-striped">
                    <thead>
                        <tr>
                            <th data-sort="number">Rank</th>
                            <th data-sort="string">Username</th>
                            <th data-sort="string">Game</th>
                            <th data-sort="number">Score</th>
                            <th data-sort="date">Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for score in global_scores %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td>{{ score.username }}</td>
                            <td>{{ score.game_name }}</td>
                            <td>{{ score.score }}</td>
                            <td>{{ score.date_played }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <a href="{{ url_for('games.games_list') }}" class="btn btn-primary">Back to Games</a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const personalTable = document.getElementById('personalTable');
    const globalTable = document.getElementById('globalTable');
    const personalSection = document.getElementById('personalScoresSection');
    const globalSection = document.getElementById('globalScoresSection');
    const personalBtn = document.getElementById('personalViewBtn');
    const globalBtn = document.getElementById('globalViewBtn');
    
    let isAdmin = document.body.getAttribute('data-user-role') === 'admin';
    let currentView = isAdmin ? 'global' : ('{{ view_type }}' || 'personal');
    let updateInterval = null;

    // Initialize view
    switchView(currentView);

    // Function to switch between views
    function switchView(view) {
        if (isAdmin && view === 'personal') {
            return; // Prevent admins from switching to personal view
        }
        
        currentView = view;
        
        if (view === 'personal') {
            personalSection.style.display = 'block';
            globalSection.style.display = 'none';
            personalBtn.className = 'btn btn-primary';
            globalBtn.className = 'btn btn-outline-primary';
        } else {
            personalSection.style.display = 'none';
            globalSection.style.display = 'block';
            personalBtn.className = 'btn btn-outline-primary';
            globalBtn.className = 'btn btn-primary';
        }
        
        // Update data for the current view
        updateLeaderboard();
    }

    // Function to update leaderboard data
    function updateLeaderboard() {
        const statusElement = document.getElementById('updateStatus');
        statusElement.textContent = 'Updating...';
        statusElement.className = 'text-warning';
        
        const apiUrl = currentView === 'personal' 
            ? '{{ url_for("leaderboard.leaderboard_api") }}?view=personal'
            : '{{ url_for("leaderboard.leaderboard_api") }}?view=global';
        
        fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                const scores = currentView === 'personal' ? data.user_scores : data.global_scores;
                const table = currentView === 'personal' ? personalTable : globalTable;
                const tbody = table.querySelector('tbody');
                
                // Clear existing rows
                tbody.innerHTML = '';

                // Add new rows
                scores.forEach((score, index) => {
                    const row = document.createElement('tr');
                    if (currentView === 'personal') {
                        row.innerHTML = `
                            <td>${index + 1}</td>
                            <td>${score.game_name}</td>
                            <td>${score.score}</td>
                            <td>${score.date_played}</td>
                        `;
                    } else {
                        row.innerHTML = `
                            <td>${index + 1}</td>
                            <td>${score.username}</td>
                            <td>${score.game_name}</td>
                            <td>${score.score}</td>
                            <td>${score.date_played}</td>
                        `;
                    }
                    tbody.appendChild(row);
                });

                // Add a subtle animation to indicate update
                table.style.transition = 'opacity 0.3s';
                table.style.opacity = '0.7';
                setTimeout(() => {
                    table.style.opacity = '1';
                }, 300);
                
                statusElement.textContent = 'Live';
                statusElement.className = 'text-success';
            })
            .catch(error => {
                console.error('Error updating leaderboard:', error);
                statusElement.textContent = 'Offline';
                statusElement.className = 'text-danger';
            });
    }

    // Start real-time updates
    function startRealtimeUpdates() {
        updateInterval = setInterval(updateLeaderboard, 5000); // Update every 5 seconds
    }

    // Stop real-time updates
    function stopRealtimeUpdates() {
        if (updateInterval) {
            clearInterval(updateInterval);
            updateInterval = null;
        }
    }

    // Initial update
    updateLeaderboard();
    startRealtimeUpdates();

    // Handle page visibility changes (pause when tab is not visible)
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            stopRealtimeUpdates();
        } else {
            updateLeaderboard(); // Immediate update when tab becomes visible
            startRealtimeUpdates();
        }
    });
});

// Make switchView available globally for button clicks
function switchView(view) {
    if (isAdmin && view === 'personal') {
        return; // Prevent admins from switching to personal view
    }
    
    const personalSection = document.getElementById('personalScoresSection');
    const globalSection = document.getElementById('globalScoresSection');
    const personalBtn = document.getElementById('personalViewBtn');
    const globalBtn = document.getElementById('globalViewBtn');
    
    if (view === 'personal') {
        personalSection.style.display = 'block';
        globalSection.style.display = 'none';
        personalBtn.className = 'btn btn-primary';
        globalBtn.className = 'btn btn-outline-primary';
    } else {
        personalSection.style.display = 'none';
        globalSection.style.display = 'block';
        personalBtn.className = 'btn btn-outline-primary';
        globalBtn.className = 'btn btn-primary';
    }
    
    // Trigger update for the new view
    const statusElement = document.getElementById('updateStatus');
    statusElement.textContent = 'Updating...';
    statusElement.className = 'text-warning';
    
    const apiUrl = view === 'personal' 
        ? '{{ url_for("leaderboard.leaderboard_api") }}?view=personal'
        : '{{ url_for("leaderboard.leaderboard_api") }}?view=global';
    
    fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
            const scores = view === 'personal' ? data.user_scores : data.global_scores;
            const table = view === 'personal' ? document.getElementById('personalTable') : document.getElementById('globalTable');
            const tbody = table.querySelector('tbody');
            
            // Clear existing rows
            tbody.innerHTML = '';

            // Add new rows
            scores.forEach((score, index) => {
                const row = document.createElement('tr');
                if (view === 'personal') {
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${score.game_name}</td>
                        <td>${score.score}</td>
                        <td>${score.date_played}</td>
                    `;
                } else {
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${score.username}</td>
                        <td>${score.game_name}</td>
                        <td>${score.score}</td>
                        <td>${score.date_played}</td>
                    `;
                }
                tbody.appendChild(row);
            });

            // Add a subtle animation to indicate update
            table.style.transition = 'opacity 0.3s';
            table.style.opacity = '0.7';
            setTimeout(() => {
                table.style.opacity = '1';
            }, 300);
            
            statusElement.textContent = 'Live';
            statusElement.className = 'text-success';
        })
        .catch(error => {
            console.error('Error updating leaderboard:', error);
            statusElement.textContent = 'Offline';
            statusElement.className = 'text-danger';
        });
}
</script>
{% endblock %}